<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="google-site-verification" content="acAEm8WsV7YCaPsZ2zflrzGZZB5r5fIRitxA4GkQ14Q"><meta name="description" content="Software development - techniques, opinions, thoughts"><title>FluentAssertions equivalency for polymorph properties | Code Ronin</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/dark.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml,rss2.xml"><script src="https://www.googletagmanager.com/gtag/js?id=G-8L9Y2PVNJE"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-8L9Y2PVNJE');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">FluentAssertions equivalency for polymorph properties</h1><a id="logo" href="/.">Code Ronin</a><p class="description">Random thoughts about software development</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a><a href="/Legal/"><i class="fa fa-legal"> Legal</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">FluentAssertions equivalency for polymorph properties</h1><div class="post-meta">2021-01-14</div><div class="post-content"><p>While I couldn’t imagine a life without the excellent <a target="_blank" rel="noopener" href="https://fluentassertions.com/">FluentAssertions</a> library, there are a few bits I find rather counter-intuitive. </p>
<p>The other day I stumbled across one of them once again and thought this actually makes for a good blog post because quite likely it will bite you in the ass, too, eventually, dear reader, or maybe already even has <strong>without you noticing</strong>.</p>
<p>Take the following data-structures (simplified from my actual use case, for the sake of clarity):</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IAction</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">string</span> TargetId &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RenameAction</span> : <span class="title">IAction</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> TargetId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> NewName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DeleteAction</span> : <span class="title">IAction</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> TargetId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Command</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> IList&lt;IAction&gt; Actions &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>and now let’s write a simple test using FluentAssertions:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> input = <span class="keyword">new</span> Command</span><br><span class="line">&#123;</span><br><span class="line">    Actions = <span class="keyword">new</span> List&lt;IAction&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> RenameAction</span><br><span class="line">        &#123;</span><br><span class="line">            TargetId = <span class="string">&quot;alpha&quot;</span>,</span><br><span class="line">            NewName = <span class="string">&quot;changed&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">new</span> DeleteAction &#123;TargetId = <span class="string">&quot;bravo&quot;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">input.Should()</span><br><span class="line">    .BeEquivalentTo(<span class="keyword">new</span> Command</span><br><span class="line">    &#123;</span><br><span class="line">        Actions = <span class="keyword">new</span> List&lt;IAction&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">new</span> RenameAction &#123;TargetId = <span class="string">&quot;alpha&quot;</span>&#125;,</span><br><span class="line">            <span class="keyword">new</span> RenameAction &#123;TargetId = <span class="string">&quot;bravo&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>Does this test pass or fail?</p>
<p>If you are like me, you expect it to fail because after all <code>input.Actions</code> contains one <code>RenameAction</code> and one <code>DeleteAction</code> while the comparand for <code>.BeEquivalentTo()</code> contains two <code>RenameAction</code>s.</p>
<p>Alas, this test actually passes. </p>
<p>The reason for this is that <strong>FluentAssertions by default does not care about the runtime types when doing an equivalency comparison</strong>. This allows you, for example, to compare a returned interface against a concrete type, or comparisons against anonymous types.</p>
<p>There is a remedy. You just have to add a configuration parameter to the equivalency check:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> input = <span class="keyword">new</span> Command</span><br><span class="line">&#123;</span><br><span class="line">    Actions = <span class="keyword">new</span> List&lt;IAction&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> RenameAction</span><br><span class="line">        &#123;</span><br><span class="line">            TargetId = <span class="string">&quot;alpha&quot;</span>,</span><br><span class="line">            NewName = <span class="string">&quot;changed&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="keyword">new</span> DeleteAction &#123;TargetId = <span class="string">&quot;bravo&quot;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">input.Should()</span><br><span class="line">    .NotBeEquivalentTo(</span><br><span class="line">        <span class="keyword">new</span> Command</span><br><span class="line">        &#123;</span><br><span class="line">            Actions = <span class="keyword">new</span> List&lt;IAction&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> RenameAction &#123;TargetId = <span class="string">&quot;alpha&quot;</span>&#125;,</span><br><span class="line">                <span class="keyword">new</span> RenameAction &#123;TargetId = <span class="string">&quot;bravo&quot;</span>&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, cfg =&gt; cfg.RespectingRuntimeTypes());</span><br></pre></td></tr></table></figure>

<p>Now the test will fail.</p>
<p>Personally, I find this extremely counter-intuitive - so much so that I know I have come already multiple times upon this, but each time I do it baffles me again for a second or two.</p>
<p>I would find it much more intuitive if the default behavior was to check the runtime types, and you’d have to actively turn off this behavior. Why? Because that way the likelihood of writing a test that passes where it should actually fail would be smaller.</p>
<p>Of course, as long as we are doing proper TDD, this cannot happen because we are writing the test before the production code, so we notice the discrepancy immediately. This is actually how I noticed it this time around. However, reality is not always so kind, and often we have to bring code under test that has already been implemented. In these scenarios, the default behavior of FluentAssertions violates the <a target="_blank" rel="noopener" href="https://wiki.c2.com/?PrincipleOfLeastAstonishment">Principle of least surprise</a>.</p>
</div><div class="tags"><a href="/tags/FluentAssertions/"><i class="fa fa-tag"></i>FluentAssertions</a><a href="/tags/TDD/"><i class="fa fa-tag"></i>TDD</a><a href="/tags/polymorph/"><i class="fa fa-tag"></i>polymorph</a><a href="/tags/equivalency/"><i class="fa fa-tag"></i>equivalency</a></div><div class="post-nav"><a class="pre" href="/2021/04/10/renameproject-v2-1-3/">renameproject v2.1.3</a><a class="next" href="/2021/01/08/renameproject-v2-1-2/">renameproject v2.1.2</a></div></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Modern Ronin.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo</a> Theme based on <a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo">Maupassant</a> </div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>