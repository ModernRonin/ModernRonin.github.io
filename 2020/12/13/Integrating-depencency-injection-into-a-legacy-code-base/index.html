<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="google-site-verification" content="acAEm8WsV7YCaPsZ2zflrzGZZB5r5fIRitxA4GkQ14Q"><meta name="description" content="Software development - techniques, opinions, thoughts"><title>Integrating dependency injection into a legacy code base | Code Ronin</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/dark.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml,rss2.xml"><script src="https://www.googletagmanager.com/gtag/js?id=G-8L9Y2PVNJE"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-8L9Y2PVNJE');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Integrating dependency injection into a legacy code base</h1><a id="logo" href="/.">Code Ronin</a><p class="description">Random thoughts about software development</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a><a href="/Legal/"><i class="fa fa-legal"> Legal</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">Integrating dependency injection into a legacy code base</h1><div class="post-meta">2020-12-13</div><div class="post-content"><p>Nobody likes it, but most of us eventually encounter a legacy code-base without tests and without IOC where everything revolves around the dreaded singleton pattern.</p>
<p>Now how do you work with such a beast? Refactoring the whole code-base to use IOC is usually as unrealistic as test-covering all existing code. For the testing aspect, accepted wisdom says to cover all new code and refactor code that you touch. </p>
<p>But how do we deal with these singletons and the lack of IOC? Is there also a way to introduce it gradually, to create an island of sanity that can slowly grow over time?</p>
<p>In this article, I’ll show you how I dealt with this just recently. I use <a target="_blank" rel="noopener" href="https://autofac.org/">Autofac</a> because this has been my preferred container framework for years. </p>
<h2 id="Initial-situation"><a href="#Initial-situation" class="headerlink" title="Initial situation"></a>Initial situation</h2><p>Let’s start with what I found before the refactoring:</p>
<p>There was a type called <code>Repository</code>, split over 8 partial classes, all together coming in at around 7000 lines of code. That type was really not a repository at all, but a typical <a target="_blank" rel="noopener" href="https://wiki.c2.com/?GodClass">God object</a>. It contained only static members. At least 30-40% of calls into that class came from static members of other types or by singletons.</p>
<p>For reasons unrelated to this discussion, I had to change some functionality related to sending notifications (yes, I know - I told you it was a god-object) which was what prompted me to make that portion of behavior testable.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for this article I don&#x27;t replicate the partial classes,</span></span><br><span class="line"><span class="comment">// they really don&#x27;t make any difference</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Repository</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// imagine a HUGE list of private fields here</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid sender, Guid[] recipients, <span class="built_in">string</span> text</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid[] recipients, <span class="built_in">string</span> text</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        SendTextNotification(<span class="keyword">this</span>.CurrentUserId, recipients, text);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SendMouseNotification</span>(<span class="params">Guid sender, Guid[] recipients, MouseState state</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// imagine around 20 other Send... methods here</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// and don&#x27;t forget the methods related to document upload, download</span></span><br><span class="line">    <span class="comment">// internal graph manipulation, caching, application versioning </span></span><br><span class="line">    <span class="comment">// and updating and so on</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Convert-static-access-to-Singleton"><a href="#Convert-static-access-to-Singleton" class="headerlink" title="Convert static access to Singleton"></a>Convert static access to Singleton</h2><p>The first thing to do is to turn the static <code>Repository</code> class into a singleton. While this doesn’t seem like much of an improvement, it enables further refactoring down the line. </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Repository</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// from now on I leave out all members not relevant to the current discussion</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid sender, Guid[] recipients, <span class="built_in">string</span> text</span>)</span> &#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid[] recipients, <span class="built_in">string</span> text</span>) </span></span><br><span class="line"><span class="function"></span>        =&gt; SendTextNotification(<span class="keyword">this</span>.CurrentUserId, recipients, text);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMouseNotification</span>(<span class="params">Guid sender, Guid[] recipients, MouseState state</span>)</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Repository Instance &#123;<span class="keyword">get</span>;&#125;= <span class="keyword">new</span> Repository();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Basically: just remove all <code>static modifiers</code>, then add the canonical <code>Instance</code> property. </p>
<p>Now of course you have to go over all callers and change calls from <code>Repository.Send...</code> to <code>Repository.Instance.Send...</code>. That sounds painful if like me you have literally 1000s of references, but ReSharper’s extremely handy <a target="_blank" rel="noopener" href="https://www.jetbrains.com/help/resharper/Navigation_and_Search__Structural_Search_and_Replace.html">structural search and replace</a> allows to do this pretty quickly. </p>
<h2 id="Change-to-access-via-interface"><a href="#Change-to-access-via-interface" class="headerlink" title="Change to access via interface"></a>Change to access via interface</h2><p>Now we can make consumers of <code>Repository</code>‘s API access it via an interface:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRepository</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// just pull all public members from Repository here</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Repository</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid sender, Guid[] recipients, <span class="built_in">string</span> text</span>)</span> &#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid[] recipients, <span class="built_in">string</span> text</span>) </span></span><br><span class="line"><span class="function"></span>        =&gt; SendTextNotification(<span class="keyword">this</span>.CurrentUserId, recipients, text);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMouseNotification</span>(<span class="params">Guid sender, Guid[] recipients, MouseState state</span>)</span> &#123;...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IRepository Instance &#123;<span class="keyword">get</span>;&#125;= <span class="keyword">new</span> Repository();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note how the <code>Instance</code> property now returns the interface instead of the concrete type.</p>
<h2 id="Create-new-type"><a href="#Create-new-type" class="headerlink" title="Create new type"></a>Create new type</h2><p>So far so good, but it would still be an enormous drag to test changes to the <code>Send*</code> methods. We have to separate somehow the sending functionality from <code>Repository</code> into a new type. </p>
<p>To do this, we create a new type <code>Sender</code> and copy all related methods from <code>Repository</code> there. </p>
<p>It may seem tempting to move the methods right away, but trust me, it’s not a good idea. In the many years I have been doing such refactorings, in at least 5 out of 10 times moving from the start eventually led to problems and forced me to revert and re-start the process with copying, thus losing more time than if I’d copied from the start.</p>
<p>So our <code>Repository</code> stays unchanged for now and our new <code>Sender</code> looks like this:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sender</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid sender, Guid[] recipients, <span class="built_in">string</span> text</span>)</span> &#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid[] recipients, <span class="built_in">string</span> text</span>) </span></span><br><span class="line"><span class="function"></span>        =&gt; SendTextNotification(<span class="keyword">this</span>.CurrentUserId, recipients, text);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMouseNotification</span>(<span class="params">Guid sender, Guid[] recipients, MouseState state</span>)</span> &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Unfortunately, it turns out <code>Sender</code> won’t compile because it depends on <code>CurrentUserId</code>. </p>
<p>You would have to be rather lucky to not encounter such a problem. Private members that are <em>only used by the <code>Send*</code> methods</em> are no problem, you can just copy them, too. But members used by <code>Send*</code> methods <em>and</em> other members of <code>Repository</code> (or even exposed in <code>IRepository</code>) are more complicated. For the sake of this article, I will assume just one such member. If there are more, up to a certain limit, you can still go the same route. Beyond 4-5, though, you probably will have to group the methods you want to extract into another type according to the dependencies they have on <code>Repository</code>.</p>
<h2 id="Deal-with-back-tracing-dependencies"><a href="#Deal-with-back-tracing-dependencies" class="headerlink" title="Deal with back-tracing dependencies"></a>Deal with back-tracing dependencies</h2><p>Now, because <code>Repository</code> is a singleton, we could just replace the reference <code>this.CurrentUserId</code> with <code>Repository.CurrentUserId</code>. However, this would defeat the purpose of the whole exercise, which is to carve out a <em>clean island of code</em> from <code>Repository</code>.</p>
<p>Instead, we extract another interface from <code>IRepository</code> (if <code>CurrentUserId</code> was not part of <code>IRepository</code>, but only, say, a private member of <code>Repository</code>, you would have to make it <code>public</code> and extract the new interface from <code>Repository</code> instead):</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ICurrentUserHolder</span></span><br><span class="line">&#123;</span><br><span class="line">    Guid CurrentUserId &#123;<span class="keyword">get</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRepository</span> : <span class="title">ICurrentUserHolder</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You might object that <code>ICurrentUserHolder</code> is a bad name and poor naming often is a symptom of bad type composition. And probably you would be right: having a type to hold the id of the current user is poor design. However, this is a hopefully temporary workaround to get us out of <em>much worse</em> design. And in the longer run, either the interface will turn into a more reasonable form, with other members and a better name, or maybe the need for it will disappear altogether by changing the contract to always require consumers of the <code>Send*</code> APIs to supply the sender. </p>
<p>Now we only need to adjust our newly minted <code>Sender</code> type to get this injected:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sender</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">readonly</span> ICurrentUserHolder _currentUserHolder;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Sender</span>(<span class="params">ICurrentUserHolder currentUserHolder</span>)</span></span><br><span class="line"><span class="function"></span>        =&gt; _currentUserHolder= currentUserHolder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid sender, Guid[] recipients, <span class="built_in">string</span> text</span>)</span> &#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid[] recipients, <span class="built_in">string</span> text</span>) </span></span><br><span class="line"><span class="function"></span>        =&gt; SendTextNotification(_currentUserHolder_.CurrentUserId, recipients, text);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMouseNotification</span>(<span class="params">Guid sender, Guid[] recipients, MouseState state</span>)</span> &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Et voilà, it compiles. </p>
<h2 id="Test-cover-and-perform-desired-functionality-changes"><a href="#Test-cover-and-perform-desired-functionality-changes" class="headerlink" title="Test-cover and perform desired functionality changes"></a>Test-cover and perform desired functionality changes</h2><p>This is now the time to bring it under test and perform any desired changes in behavior. </p>
<h2 id="Make-Production-code-use-Sender"><a href="#Make-Production-code-use-Sender" class="headerlink" title="Make Production code use Sender"></a>Make Production code use Sender</h2><p>We still have a few issues to solve:</p>
<ul>
<li><code>Sender</code> is not yet being used by any production code, in place of the old corresponding methods of <code>Repository</code></li>
<li><code>Sender</code> effectively depends on <code>Repository</code> and we need to solve construction of <code>Sender</code> instances at runtime</li>
<li>we still haven’t fulfilled my promise from the outset of the article, to introduce an island of code using a container</li>
</ul>
<p>So next we extract an interface from <code>Sender</code>, mirroring its public interface:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISender</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid sender, Guid[] recipients, <span class="built_in">string</span> text</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid[] recipients, <span class="built_in">string</span> text</span>)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SendMouseNotification</span>(<span class="params">Guid sender, Guid[] recipients, MouseState state</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sender</span> : <span class="title">ISender</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">readonly</span> ICurrentUserHolder _currentUserHolder;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Sender</span>(<span class="params">ICurrentUserHolder currentUserHolder</span>)</span></span><br><span class="line"><span class="function"></span>        =&gt; _currentUserHolder= currentUserHolder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid sender, Guid[] recipients, <span class="built_in">string</span> text</span>)</span> &#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid[] recipients, <span class="built_in">string</span> text</span>) </span></span><br><span class="line"><span class="function"></span>        =&gt; SendTextNotification(_currentUserHolder_.CurrentUserId, recipients, text);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMouseNotification</span>(<span class="params">Guid sender, Guid[] recipients, MouseState state</span>)</span> &#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then we inject this interface into our <code>Repository</code> and make it use it:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Repository</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> ISender Sender &#123;<span class="keyword">get</span>;&#125;            <span class="comment">// note we use a public property</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Repository</span>(<span class="params">ISender sender</span>)</span></span><br><span class="line"><span class="function"></span>        =&gt; Sender= sender;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid sender, Guid[] recipients, <span class="built_in">string</span> text</span>) </span></span><br><span class="line"><span class="function"></span>        =&gt; Sender.SendTextNotification(sender, recipients, text);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendTextNotification</span>(<span class="params">Guid[] recipients, <span class="built_in">string</span> text</span>) </span></span><br><span class="line"><span class="function"></span>        =&gt; Sender.SendTextNotification(recipients, text);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendMouseNotification</span>(<span class="params">Guid sender, Guid[] recipients, MouseState state</span>)</span></span><br><span class="line"><span class="function"></span>        =&gt; Sender.SendMouseNotification(sender, recipients, text);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IRepository Instance &#123;<span class="keyword">get</span>;&#125;= <span class="keyword">new</span> Repository(); <span class="comment">// compile time error </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRepository</span> </span><br><span class="line">&#123;</span><br><span class="line">    ISender Sender &#123;<span class="keyword">get</span>;&#125;                   <span class="comment">// we need to pull this here, too</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>There is a problem now, we can’t instantiate our singleton anymore. This problem will go away in a minute. We really don’t want our <code>Repository</code> to include all those <code>Send*</code> methods, after all that’s part of why we created <code>ISender</code> in the first place. We want our callers to use <code>ISender</code> directly instead.</p>
<p>The solution for both issues is really the same:</p>
<p>First, we create a new static type called <code>Globals</code> and move the <code>.Instance</code> property from <code>Repository</code> there, renaming it simultaneously:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Globals</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IRepository Repository &#123;<span class="keyword">get</span>;&#125;= <span class="keyword">new</span> Repository(); <span class="comment">// compile-time error </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can do this automatically with R#, updating all references correctly. </p>
<p>Next we inline all calls to any <code>Send*</code> method of <code>Repository</code> (again, using R#). This step is why we used a public property <code>Repository.Sender</code> before. Had we used a private field, this step now would lead to lots of compile-time errors.</p>
<p>After this, calls will look like:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Globals.Repository.Sender.SendTextNotification(sender, recipients, text);</span><br></pre></td></tr></table></figure>

<p>Note how this now actually looks uglier than it did before this step. Callers are now required to do use a nested qualifier (<code>Globals.Repository.Sender.</code>) where before they could use a simple one (<code>Repository</code>). This is an example of a pattern occurring quite regularly when refactoring legacy code: you have to temporarily refactor to worse design to get to better design in the end. </p>
<p><code>Repository</code> and <code>IRepository</code> no longer need the <code>Send*</code> methods.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Repository</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// there is still a HUGE list of private fields here, but none </span></span><br><span class="line">    <span class="comment">// related to sending notifications anymore</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ISender Sender &#123;<span class="keyword">get</span>;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Repository</span>(<span class="params">ISender sender</span>)</span></span><br><span class="line"><span class="function"></span>        =&gt; Sender= sender;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Repository now contains only the methods related to document upload, download</span></span><br><span class="line">    <span class="comment">// internal graph manipulation, caching, application versioning </span></span><br><span class="line">    <span class="comment">// and updating and so on</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Next we add another property to <code>Globals</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Globals</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IRepository Repository &#123;<span class="keyword">get</span>;&#125;= <span class="keyword">new</span> Repository(); <span class="comment">// compile time error </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ISender Sender &#123;<span class="keyword">get</span>;&#125;= <span class="keyword">new</span> Sender(); <span class="comment">// compile-time error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Don’t worry about the compile-time errors, they are going to go away shortly.</p>
<p>Now we turn again to our friend <a target="_blank" rel="noopener" href="https://www.jetbrains.com/help/resharper/Navigation_and_Search__Structural_Search_and_Replace.html">structural search and replace</a> and replace all references to the <code>Send*</code> methods like</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Globals.Repository.Sender.SendTextNotification(sender, recipients, text);</span><br></pre></td></tr></table></figure>

<p>with</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Globals.Sender.SendTextNotification(sender, recipients, text);</span><br></pre></td></tr></table></figure>

<p>and, at long last, we can remove the <code>Sender</code> property from <code>Repository</code> and <code>IRepository</code> again, and <code>Repository</code> thus has got a default constructor again.</p>
<p>With this we have solved the first of the problems mentioned further up, production code everywhere now uses our clean, well-tested <code>Sender</code>, and <code>Repository</code> knows nothing about sending anymore.</p>
<h2 id="Introduce-IOC-container"><a href="#Introduce-IOC-container" class="headerlink" title="Introduce IOC container"></a>Introduce IOC container</h2><p>Finally, we can introduce a container, solving the remaining two issues.</p>
<p>First, we create an <a target="_blank" rel="noopener" href="https://autofaccn.readthedocs.io/en/latest/configuration/modules.html">Autofac’s module</a>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IslandModule</span> : <span class="title">Module</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Load</span>(<span class="params">ContainerBuilder builder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        builder.RegisterType&lt;Repository&gt;().AsImplementedInterfaces();</span><br><span class="line">        builder.RegisterType&lt;Sender&gt;().AsImplementedInterfaces();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then we adjust <code>Globals</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Globals</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">readonly</span> <span class="title">Lazy</span>&lt;<span class="title">Globals</span>&gt; _instance</span> = <span class="keyword">new</span> Lazy&lt;Globals&gt;();</span><br><span class="line">    <span class="keyword">readonly</span> IContainer _container</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Globals</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> builder = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line">        builder.RegisterModule(<span class="keyword">new</span> IslandModule());</span><br><span class="line">        _container = builder.Build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> T <span class="title">Resolve</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span>)</span> =&gt; _instance.Value._container.Resolve&lt;T&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IRepository Repository =&gt; Resolve&lt;IRepository&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ISender Sender =&gt; Resolve&lt;ISender&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note how <code>Globals</code> now internally uses a container to resolve those types migrated to it. </p>
<p>Over time, we can add more and more types as we break them out from the god-object <code>Repository</code> (or elsewhere); for new types, we can work under the assumption of a container right away; and eventually, in the future, when we will have refactored all types to use IOC, we will be able to eliminate <code>Globals</code> itself, too.</p>
<h2 id="A-few-more-questions"><a href="#A-few-more-questions" class="headerlink" title="A few more questions"></a>A few more questions</h2><p>I’ll end this article with a few remarks in question-and-answer style.</p>
<h3 id="Why-call-the-holder-of-the-singletons-Globals"><a href="#Why-call-the-holder-of-the-singletons-Globals" class="headerlink" title="Why call the holder of the singletons Globals?"></a>Why call the holder of the singletons <code>Globals</code>?</h3><p>Because it keeps everyone using it honest and serves as a reminder what is really happening when we access static members or instances from other types. </p>
<h3 id="Why-is-instance-in-Globals-modelled-as-Lazy-lt-gt"><a href="#Why-is-instance-in-Globals-modelled-as-Lazy-lt-gt" class="headerlink" title="Why is _instance in Globals modelled as Lazy&lt;&gt;?"></a>Why is <code>_instance</code> in <code>Globals</code> modelled as <code>Lazy&lt;&gt;</code>?</h3><p>Because <code>Lazy&lt;&gt;</code>‘s value generation is intrinsically thread-safe and race-conditions do not lead to creation of multiple instances. This really is the kind of problem you wouldn’t ever have if you used a container from the beginning, but we are talking about migrating legacy code here, so we must ensure thread-safety of singletons. </p>
<h3 id="What-to-do-when-mutual-dependencies-between-extracted-types-and-original-legacy-types-are-not-easily-avoidable"><a href="#What-to-do-when-mutual-dependencies-between-extracted-types-and-original-legacy-types-are-not-easily-avoidable" class="headerlink" title="What to do when mutual dependencies between extracted types and original legacy-types are not easily avoidable?"></a>What to do when mutual dependencies between extracted types and original legacy-types are not easily avoidable?</h3><p>For example, what if <code>Repository</code> would need to call some <code>ISender</code> methods? Then we’d have to inject <code>ISender</code> into <code>Repository</code> and<br>thus create a circular dependency between <code>Repository</code> and <code>Sender</code>. </p>
<p>The purist answer that this is a sign of poor design does not help in this context. This kind of complication happens really quite often until refactoring of the legacy types has progressed far enough. In practice this usually means many months because we don’t get to refactor everything at once. (And even if we did, it wouldn’t be wise to do it without intermediate steps, but that’s a subject for another article.)</p>
<p>When I encounter such a situation, I use a <code>Lazy&lt;&gt;</code> or <code>Func&lt;&gt;</code> injection. The refactoring effort to properly disentangle the responsibilities and dependencies is often greater than can be justified for the current scope, so this can be a useful <em>temporary</em> compromise. Usually, as refactoring continues, most of these somewhat ugly injections will fall out again. </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRepository</span> : <span class="title">ICurrentUserHolder</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Repository</span> : <span class="title">IRepository</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">readonly</span> Lazy&lt;ISender&gt; _sender;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Repository</span>(<span class="params">Lazy&lt;ISender&gt; sender</span>)</span></span><br><span class="line"><span class="function"></span>        =&gt; _sender= sender;</span><br><span class="line">    </span><br><span class="line">    ISender Sender =&gt; _sender.Value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SomeMethodDependingOnISender</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Sender.SendTextNotification(...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sender</span> : <span class="title">ISender</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">readonly</span> ICurrentUserHolder _currentUserHolder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Sender</span>(<span class="params">ICurrentUserHolder currentUserHolder</span>)</span></span><br><span class="line"><span class="function"></span>        =&gt; _currentUserHolder= currentUserHolder;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This solves the circular dependency by changing the time when one of the two instances has to be created: instead of requiring an <code>ISender</code> instance at construction time of <code>Repository</code>, it is needed only once <code>Repository</code> accesses it for the first time.</p>
<p>Whether to use <code>Lazy&lt;&gt;</code> or <code>Func&lt;&gt;</code> depends usually on whether or not the instance can change. If the instance is going to be created only once and effectively be a singleton for the duration of runtime, then <code>Lazy&lt;&gt;</code> is the better choice. If the instance can change, then <code>Lazy&lt;&gt;</code> would introduce bugs and <code>Func&lt;&gt;</code> is more correct.</p>
<p>On a side note, that both <code>Func&lt;T&gt;</code> and <code>Lazy&lt;T&gt;</code> are resolved with no additional work, for any registered <code>T</code>, is one of many reasons I like Autofac so much as a container. </p>
<h3 id="Why-use-a-Module"><a href="#Why-use-a-Module" class="headerlink" title="Why use a Module"></a>Why use a Module</h3><p>Because it allows us to re-use the registration logic in other contexts where we don’t need <code>Globals</code>.</p>
<p>At some point refactoring of the legacy code-base will have converted everything to use IOC, then we won’t need <code>Globals</code> anymore. By keeping the registration logic in a module from the start, we won’t have to touch it when that happens.</p>
<p>Further, once registration logic contains more than just a few registrations, it is a good idea to write unit-tests for it. A module is very easily testable while <code>Globals</code> is not - singletons never are. </p>
<h2 id="Thanks"><a href="#Thanks" class="headerlink" title="Thanks"></a>Thanks</h2><p>Thanks to <a target="_blank" rel="noopener" href="https://github.com/alexvallat">@alexvallat</a> for his feedback and questions!</p>
</div><div class="tags"><a href="/tags/software-design/"><i class="fa fa-tag"></i>software design</a><a href="/tags/ReSharper/"><i class="fa fa-tag"></i>ReSharper</a><a href="/tags/refactoring/"><i class="fa fa-tag"></i>refactoring</a><a href="/tags/legacy-code/"><i class="fa fa-tag"></i>legacy code</a><a href="/tags/long/"><i class="fa fa-tag"></i>long</a><a href="/tags/Autofac/"><i class="fa fa-tag"></i>Autofac</a></div><div class="post-nav"><a class="pre" href="/2020/12/17/Prevent-re-entrancy-on-long-running-async-methods/">Prevent re-entrancy on long running async methods</a><a class="next" href="/2020/12/13/renameproject-v2-1-1/">renameproject v2.1.1</a></div></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Modern Ronin.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo</a> Theme based on <a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo">Maupassant</a> </div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>