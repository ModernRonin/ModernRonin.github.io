<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="google-site-verification" content="acAEm8WsV7YCaPsZ2zflrzGZZB5r5fIRitxA4GkQ14Q"><meta name="description" content="Software development - techniques, opinions, thoughts"><title>CosmosDB and Caching | Code Ronin</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/dark.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml,rss2.xml"><script src="https://www.googletagmanager.com/gtag/js?id=G-8L9Y2PVNJE"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-8L9Y2PVNJE');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CosmosDB and Caching</h1><a id="logo" href="/.">Code Ronin</a><p class="description">Random thoughts about software development</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a><a href="/Legal/"><i class="fa fa-legal"> Legal</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">CosmosDB and Caching</h1><div class="post-meta">2020-09-01</div><div class="post-content"><p>Iff you ever work with CosmosDb and are concerned about high volume accesses:</p>
<p>CosmosDb is fast, no doubt, but because it’s never hosted in the same network as your app-services, Azure functions etc., there is still significant network lag. Because of this, it makes a huge difference to put a redis instance in front. </p>
<p>For me, in a current project, the performance gain was enormous: reads went down from 300-500ms to 50-100ms per read.</p>
<p>One caveat is this works well only for non-query reads - like “get this specific document”. For server-side queries, this doesn’t work. So depending on your usage, your mileage may vary. In my scenario, the non-query reads overwhelmingly outnumbered the query-reads statistically, so adding redis was a big win. </p>
<p>As for implementation, assuming you got something like an <code>IRepository</code> that abstracts access CosmosDb, you just add another implementation of <code>IRepository</code>, <code>RedisCachingRepositoryDecorator</code>. For each write this decorator also writes to the cache and for each read it first asks the cache; if it gets a hit, it returns that hit. If no (this should really only happen when Redis restarts or starts throwing out old data), it proceeds to ask CosmosDb, updates the cache and returns the result.</p>
<p>Here’s a sketch:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ICache</span>         <span class="comment">// this interface is a custom abstraction over the cache that&#x27;s not as Redis-specific as IDatabase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">Task <span class="title">PutAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key, T <span class="keyword">value</span>, TimeSpan timeOut</span>)</span>;</span><br><span class="line">    <span class="function"><span class="title">Task</span>&lt;<span class="title">T</span>&gt; <span class="title">GetAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key</span>)</span>;</span><br><span class="line">    <span class="function">Task <span class="title">InvalidateAsync</span>(<span class="params"><span class="keyword">params</span> <span class="built_in">string</span>[] keys</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IIdentifiable</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">JsonProperty(PropertyName = <span class="meta-string">&quot;id&quot;</span>)</span>]</span><br><span class="line">    <span class="built_in">string</span> Id &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRepository</span>&lt;<span class="title">TDocument</span>&gt; <span class="keyword">where</span> <span class="title">TDocument</span> : <span class="keyword">class</span>, <span class="title">IIdentifiable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">Task&lt;TDocument&gt; <span class="title">GetAsync</span>(<span class="params"><span class="built_in">string</span> key</span>)</span>;</span><br><span class="line">    <span class="function">Task <span class="title">PutAsync</span>(<span class="params">TDocument <span class="keyword">record</span></span>)</span>;</span><br><span class="line">    Task&lt;<span class="built_in">string</span>[]&gt; DeleteAsync(Expression&lt;Func&lt;TDocument, <span class="built_in">bool</span>&gt;&gt; filter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RedisCachingRepositoryDecorator</span>&lt;<span class="title">TDocument</span>&gt; : <span class="title">IRepository</span>&lt;<span class="title">TDocument</span>&gt;</span><br><span class="line">       <span class="keyword">where</span> <span class="title">TDocument</span> : <span class="keyword">class</span>, <span class="title">IIdentifiable</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">readonly</span> ICache _cache;</span><br><span class="line">    <span class="keyword">readonly</span> IRepository&lt;TDocument&gt; _decoree;</span><br><span class="line">    <span class="keyword">readonly</span> TimeSpan _expiry;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CachingDocumentRepositoryDecorator</span>(<span class="params">IRepository&lt;TDocument&gt; decoree, ICache cache, TimeSpan expiry</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _decoree = decoree;</span><br><span class="line">        _cache = cache;</span><br><span class="line">        _expiry = expiry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;TDocument&gt; <span class="title">GetAsync</span>(<span class="params"><span class="built_in">string</span> key</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> cacheKey = MakeCacheKey(key);</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> _cache.GetAsync&lt;TDocument&gt;(cacheKey);</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">default</span>) <span class="keyword">return</span> result;</span><br><span class="line">        result = <span class="keyword">await</span> _decoree.GetAsync(key);</span><br><span class="line">        <span class="keyword">await</span> _cache.PutAsync(cacheKey, result, _expiry);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">PutAsync</span>(<span class="params">TDocument <span class="keyword">record</span></span>)</span> =&gt;</span><br><span class="line">        Task.WhenAll(_cache.PutAsync(MakeCacheKey(record.Id), record, _expiry), _decoree.PutAsync(record));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>[]&gt; DeleteAsync(Expression&lt;Func&lt;TDocument, <span class="built_in">bool</span>&gt;&gt; filter)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> ids = <span class="keyword">await</span> _decoree.DeleteAsync(filter);</span><br><span class="line">        <span class="keyword">await</span> _cache.InvalidateAsync(ids.Select(MakeCacheKey).ToArray());</span><br><span class="line">        <span class="keyword">return</span> ids;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">MakeCacheKey</span>(<span class="params"><span class="built_in">string</span> id</span>)</span> =&gt; <span class="string">$&quot;<span class="subst">&#123;<span class="keyword">typeof</span>(TDocument).FullName&#125;</span>_<span class="subst">&#123;id&#125;</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</div><div class="tags"><a href="/tags/Azure/"><i class="fa fa-tag"></i>Azure</a><a href="/tags/CosmosDb/"><i class="fa fa-tag"></i>CosmosDb</a><a href="/tags/Redis/"><i class="fa fa-tag"></i>Redis</a><a href="/tags/Caching/"><i class="fa fa-tag"></i>Caching</a></div><div class="post-nav"><a class="pre" href="/2020/09/02/Tuple-syntax-for-multiple-assignments/">Tuple syntax for multiple assignments</a><a class="next" href="/2020/08/28/Merging-a-specific-directory-only-from-one-branch-to-another/">Merging a specific directory only from one branch to another</a></div></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Modern Ronin.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo</a> Theme based on <a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo">Maupassant</a> </div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>